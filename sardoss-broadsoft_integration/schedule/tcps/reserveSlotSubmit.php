<?phpinclude '../bin/dbinfo.inc.php';//CONNECT TO MYSQL$connection = @mysql_connect($mysqladd,$mysqluser,$mysqlpass) or die(mysql_error());$database = @mysql_select_db($databasename,$connection) or die(mysql_error());function checkSlotStatus($slot,$date){	global $connection;	global $database;		$availCount = 0;		if(strlen($slot) == 3){ 		$slotVar = "timeslot0" . $slot;	}else{		$slotVar = "timeslot" . $slot;	}		$checkSlotSQL = "SELECT $slotVar FROM tcps_time_slots WHERE DATE(date) = DATE('$date')";	$checkSlotResult = mysql_query($checkSlotSQL, $connection);	while($row = mysql_fetch_array($checkSlotResult,MYSQL_ASSOC)){		$availSlots = $row[$slotVar];	}		$slotDataSQL = "SELECT count(timeslot) AS used_slots,timeslot FROM tcps_orders WHERE DATE(activation_date) = DATE('$date') AND timeslot = '$slot'";	$slotDataResult = mysql_query($slotDataSQL,$connection);	while($count = mysql_fetch_array($slotDataResult)){		$usedSlots = $count['used_slots'];	}		if($usedSlots >= $availSlots){		return 0;	}elseif($usedSlots < $availSlots){		return 1;	}else{		return 2;	}}$time = $_POST['timeslot'];$timeslot = date("Gi",$time);$date = date("Y-m-d",$time);$timeDisplay = date("g:iA",$time);$dateDisplay = date("l, F jS, Y",$time);$availability = checkSlotStatus($timeslot,$date);$offnet = $_POST['offnet'];?><html><head><!--[if IE]><link rel="stylesheet" type="text/css" href="../style/tracker_style_ie.css" /><![endif]--><!--[if !IE]><!--><link rel="stylesheet" type="text/css" href="../style/tracker_style.css" /><!--<![endif]--><script>function refreshParent() {	window.opener.location.reload();} window.onunload = refreshParent</script><style>body{	background-color:lightgray;	text-align:center;}p{		position:relative;	top:30px}</style></head><body><?phpif($availability == 1){		$today = date("Y-m-d");		$count = 0;	$acct_name = stripslashes($_POST['acct_name']);	$acct_name = mysql_real_escape_string($acct_name);		$orderCheckSQL = "SELECT * FROM tcps_orders WHERE order_num = '$_POST[order_num]'";	$orderCheckResult = mysql_query($orderCheckSQL,$connection);	while($row = mysql_fetch_array($orderCheckResult,MYSQL_ASSOC)){		$count++;		$currDate = $row['activation_date'];		$currTime = $row['timeslot'];	}			if($count == 0){				$insertSQL = "INSERT INTO tcps_orders (acct_num,acct_name,order_num,timeslot,reserved_by,activation_date,order_type,upload_date,off_net) VALUES			('$_POST[acct_num]','$acct_name','$_POST[order_num]','$timeslot','$_POST[reserved_by]','$date','$_POST[order_type]',$today, '$offnet')";		$insertResult = mysql_query($insertSQL,$connection);		if($insertResult == 1){			echo "<p><strong>RESERVATION SUCCESSFUL.</strong><br /><br />Time slot reserved successfully<br />($timeDisplay, $dateDisplay).</p>";		}else{			echo "<p>An error occurred.  Please try again.  (error code 1: mysql insert failure)</p>";		}			}elseif($count == 1 && $currTime == ""){				$insertSQL = "UPDATE tcps_orders SET acct_num = '$_POST[acct_num]', acct_name = '$acct_name', order_type = '$_POST[order_type]', timeslot = '$timeslot',reserved_by = '$_POST[reserved_by]',activation_date='$date',upload_date='$today',tcps_tech_id='1000', off_net = '$offnet' WHERE order_num = '$_POST[order_num]'";		$insertResult = mysql_query($insertSQL,$connection);		if($insertResult == 1){			echo "<p><strong>RESERVATION SUCCESSFUL.</strong><br /><br />Time slot reserved successfully<br />($timeDisplay, $dateDisplay).</p>";		}else{			echo "<p>An error occurred.  Please try again.  (error code 5: mysql update failure)</p>";		}	}elseif($currTime != ""){				if(strlen($currTime) == 3){ $hour = substr($currTime,0,1); }else{ $hour = substr($currTime,0,2); }		$day = substr($currDate,-2);		if(substr($day,0,1) == 0){$day = substr($day,-1); }		$month =  substr($currDate,5,2);		$year = substr($currDate,0,4);		$mktimeDate = mktime($hour,30,0,$month,$day,$year);		$dupeTimeDisplay = date("g:iA",$mktimeDate);		$dupeDateDisplay = date("l, F jS, Y",$mktimeDate);		$todays_date = mktime(0,0,0,date('m'),date('j'),date('Y'));		$scheduled_date = mktime(0,0,0,$month,$day,$year);				if($scheduled_date > $todays_date){			echo "<p><strong>RESERVATION FAILED.</strong><br /><br />This order is already scheduled in another TCPS time slot. <br />($dupeTimeDisplay, $dupeDateDisplay)<br /><br />Please remove that time slot before scheduling a new one.</p>";		}elseif($scheduled_date <= $todays_date){			$insertSQL = "UPDATE tcps_orders SET acct_num = '$_POST[acct_num]', acct_name = '$acct_name', order_type = '$_POST[order_type]', timeslot = '$timeslot',reserved_by = '$_POST[reserved_by]',activation_date='$date',upload_date='$today',tcps_tech_id='1000', off_net = '$offnet' WHERE order_num = '$_POST[order_num]'";			$insertResult = mysql_query($insertSQL,$connection);			if($insertResult == 1){				echo "<p><strong>RESERVATION SUCCESSFUL.</strong><br /><br />Time slot updated successfully.<br /><br />Old Slot: $dupeTimeDisplay, $dupeDateDisplay<br />New Slot: $timeDisplay, $dateDisplay</p>";			}else{			echo "<p>An error occurred.  Please try again.  (error code 6: mysql update failure)</p>";			}		}else{			echo "<p>An error occurred.  Please try again.  (error code 7: unexpected exception encountered)</p>";		}	}else{		echo "<p><strong>RESERVATION FAILED.</strong><br /> <br /> (error code 2: duplicate order in database)</p>";	}}elseif($availability == 0){	echo "<p><strong>RESERVATION FAILED.</strong><br /><br />Time slot is no longer available. <br />($timeDisplay, $dateDisplay)<br /><br />Please choose another time slot.</p>";}elseif($availability == 2){	echo "<p>An error occurred.  Please try again.  (error code 3: slot availability error)</p>";}else{	echo "<p>An error occurred.  Please try again.  (error code 4: unexpected exception encountered)</p>";}?><br /><br /><br /><button type="button" id="slotCancel" onClick="window.close();">Close Window</button></body></html>